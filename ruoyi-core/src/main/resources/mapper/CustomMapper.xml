<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.core.mapper.CustomMapper">

    <resultMap id="BaseResultMap" type="com.ruoyi.core.entity.Custom">
        <id property="customId" column="custom_id" jdbcType="CHAR"/>
        <result property="realName" column="real_name" jdbcType="CHAR"/>
        <result property="nickName" column="nick_name" jdbcType="VARCHAR"/>
        <result property="userName" column="user_name" jdbcType="VARCHAR"/>
        <result property="passWord" column="pass_word" jdbcType="VARCHAR"/>
        <result property="address" column="address" jdbcType="VARCHAR"/>
        <result property="birthdayTime" column="birthday_time" jdbcType="TIMESTAMP"/>
        <result property="regType" column="reg_type" jdbcType="CHAR"/>
        <result property="job" column="job" jdbcType="CHAR"/>
        <result property="regTime" column="reg_time" jdbcType="TIMESTAMP"/>
        <result property="updateTime" column="update_time" jdbcType="TIMESTAMP"/>
        <result property="status" column="status" jdbcType="CHAR"/>
        <result property="remarks" column="remarks" jdbcType="VARCHAR"/>
    </resultMap>

    <sql id="Base_Column_List">
        custom_id,real_name,nick_name,
        user_name,pass_word,address,
        birthday_time,
        reg_type,job,reg_time,
        update_time,status,remarks
    </sql>
    <select id="getCustomList" resultType="com.ruoyi.core.entity.vo.CustomListVO">
        select t.real_name,
               twc.sex,
               twc.weChat_number,
               tc.car_number,
               twc.phone,
               t.address,
               t.status,
               (select sum(o.total_price) from t_order o where t.custom_id = o.custom_id) as consumptionTotal,
               (select o.create_time
                from t_order o
                where t.custom_id = o.custom_id
                order by o.create_time desc
                limit 0,1)                                                               as lastConsumptionDate
        from t_custom t
                 inner join t_car tc on t.custom_id = tc.custom_id
                 inner join t_wechat_custom twc on t.custom_id = twc.custom_id
                 inner join t_order o on t.custom_id = o.custom_id
        <where>
            <if test="realName !=null and realName != ''">
                and t.real_name = #{realName}
            </if>
            <if test="sex !=null and sex != ''">
                and twc.sex = #{sex}
            </if>
            <if test="carNumber !=null and carNumber != ''">
                and tc.car_number = #{carNumber}
            </if>
            <if test="phone !=null and phone != ''">
                and twc.phone = #{phone}
            </if>
            <if test="status !=null and status != ''">
                and t.status = #{status}
            </if>
            <if test="status !=null and status != ''">
                and t.status = #{status}
            </if>
            <if test="params.beginTime != null and params.beginTime != ''"><!-- 开始时间检索 -->
                AND date_format(o.create_time,'%y%m%d') &gt;= date_format(#{params.beginTime},'%y%m%d')
            </if>
            <if test="params.endTime != null and params.endTime != ''"><!-- 结束时间检索 -->
                AND date_format(o.create_time,'%y%m%d') &lt;= date_format(#{params.endTime},'%y%m%d')
            </if>
        </where>
    </select>

</mapper>
